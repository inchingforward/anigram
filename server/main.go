package main

import (
	"flag"
	"io"
	"log"
	"net/http"
	"os"
	"path"

	"github.com/flosch/pongo2/v4"
	"github.com/gorilla/sessions"
	_ "github.com/iris-contrib/pongo2-addons/v4"
	"github.com/labstack/echo-contrib/session"
	"github.com/labstack/echo/v4"
	"github.com/labstack/echo/v4/middleware"
)

// Renderer renders templates.
type Renderer struct {
	TemplateDir   string
	Reload        bool
	TemplateCache map[string]*pongo2.Template
}

var (
	debug    bool
	storeKey string
)

type ServerData struct {
	Title string `json:"title"`
	Data  string `json:"data"`
}

// GetTemplate returns a template, loading it every time if reload is true.
func (r *Renderer) GetTemplate(name string, reload bool) *pongo2.Template {
	filename := path.Join(r.TemplateDir, name)

	if r.Reload {
		return pongo2.Must(pongo2.FromFile(filename))
	}

	return pongo2.Must(pongo2.FromCache(filename))
}

// Render renders a pongo2 template.
func (r *Renderer) Render(w io.Writer, name string, data interface{}, c echo.Context) error {
	template := r.GetTemplate(name, debug)
	pctx := data.(pongo2.Context)

	sess, err := session.Get("session", c)
	if err == nil {
		pctx["session"] = sess
	}

	return template.ExecuteWriter(pctx, w)
}

func init() {
	// db, err := sqlx.Connect("postgres", "user=postgres dbname=logbook sslmode=disable")
	// if err != nil {
	// 	log.Fatal(err)
	// }

	//setDB(db)

	storeKey := os.Getenv("ANIGRAM_STORE_KEY")
	if storeKey == "" {
		log.Fatal("The ANIGRAM_STORE_KEY is not set")
	}

	//gob.Register(SessionUser{})
}

func getIndex(c echo.Context) error {
	return c.Render(http.StatusOK, "index.html", pongo2.Context{})
}

func getAbout(c echo.Context) error {
	return echo.NewHTTPError(http.StatusNotImplemented)
}

func getNewAnimation(c echo.Context) error {
	return echo.NewHTTPError(http.StatusNotImplemented)
}

func getAnimationEdit(c echo.Context) error {
	return c.Render(http.StatusOK, "animation_edit.html", pongo2.Context{})
}

func getAnimation(c echo.Context) error {
	s := ServerData{
		Title: "Testing",
		Data:  "0000000000000000000000000000000000000000200000000000000220000000000000222000000000000002200000000000000220000000000000022000000000000002200000000000000220000000000000022000000000000002200000000000002222000000000000222200000000000022200000000000000000000000000000000000000000002222200000000002222222000000022220000220000000200000022200000000000002220000000000002222000000000222220000000002222220000000002200000000000000220000000000000222000022220000022222222220000000222222220000000000000000000000000000000000000000000000000000000000222000000000000222222000000002220002200000000222000022000000022000002200000000000022220000000000022220000000000000002000000000000000220000000222000222000000022200022200000002222222220000000000222220000000000000000000000000000000000000000000000000000000000000220000000000000222000000000000222000000000000222200000000000222020000000000022002000000000022200200000000002222222222000000022222222200000000000200000000000000020000000000000022200000000000002220000000000000222000000000000000000000000000000000000000000222222222000000022222222200000022200000220000002220000000000000222222222000000002222222220000000222200022200000000000002220000220000000222000022200000022200002220000002200000222220022220000002222222220000000000000000000000000000000000000000000000000000000000022222000000000222222220000000222222200000000220000000000000022000000000000002200222220000000220222222200000022220000222000002220000002200000022000002220000002220022222000000022222222000000002222222000000000022220000000000000000000000000000000000000000000000000000000000222222222200000222222222220000022222000220000000220000022000000000000022000000000000022200000000000002200000000000000220000000000000220000000000000222000000000000022200000000000022220000000000000222000000000000000000000000000000000000000000002222000000000002222220000000000222222200000000022000220000000002200022000000000222222000000000002222200000000002222022000000002200002220000000220000222000000022000022200000002222222200000000222222200000000000000000000000000000000000000000000000000000000000222222000000000022222200000000022222222000000022200002200000002220000220000000222000022000000002200002200000000222002220000000022222222000000000222220200000022000000220000002220000220000000022222222000000000222220000000000000000000000000000000000000000000000000000000000020000222200000022000222222000022200022222200000220022000022000022002000002200002200200000220000220020000022000022002000002200002200220002200000220022222220000222202222220000022220022220000002220000000000000000000000000000"}

	return c.JSON(http.StatusOK, s)
}

func postAnimation(c echo.Context) error {
	return echo.NewHTTPError(http.StatusNotImplemented)
}

func main() {
	flag.BoolVar(&debug, "debug", false, "true to enable debug")
	flag.Parse()

	log.Printf("debug: %v\n", debug)

	InitDB()

	e := echo.New()

	e.Use(middleware.Logger())
	e.Use(session.Middleware(sessions.NewCookieStore([]byte(storeKey))))

	e.Renderer = &Renderer{TemplateDir: "templates", Reload: debug, TemplateCache: make(map[string]*pongo2.Template)}

	e.Static("/static", "static")
	e.GET("/", getIndex)
	e.GET("/about", getAbout)
	e.GET("/animations/new", getNewAnimation)
	e.GET("/animations/:uuid/edit", getAnimationEdit)
	e.GET("/api/animations/:uuid", getAnimation)
	e.POST("/api/animations", postAnimation)

	e.Logger.Fatal(e.Start(":3000"))
}
